---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# broomExtra

<!-- badges: start -->
[![CRAN_Release_Badge](http://www.r-pkg.org/badges/version-ago/broomExtra)](https://CRAN.R-project.org/package=broomExtra)
[![CRAN Checks](https://cranchecks.info/badges/summary/broomExtra)](https://cran.r-project.org/web/checks/check_results_broomExtra.html)
[![packageversion](https://img.shields.io/badge/Package%20version-0.0.3-orange.svg?style=flat-square)](https://github.com/IndrajeetPatil/broomExtra/commits/master)
[![Daily downloads badge](https://cranlogs.r-pkg.org/badges/last-day/broomExtra?color=blue)](https://CRAN.R-project.org/package=broomExtra)
[![Weekly downloads badge](https://cranlogs.r-pkg.org/badges/last-week/broomExtra?color=blue)](https://CRAN.R-project.org/package=broomExtra)
[![Monthly downloads badge](https://cranlogs.r-pkg.org/badges/last-month/broomExtra?color=blue)](https://CRAN.R-project.org/package=broomExtra)
[![Total downloads badge](https://cranlogs.r-pkg.org/badges/grand-total/broomExtra?color=blue)](https://CRAN.R-project.org/package=broomExtra)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/IndrajeetPatil/broomExtra?branch=master&svg=true)](https://ci.appveyor.com/project/IndrajeetPatil/broomExtra)
[![Travis build status](https://travis-ci.org/IndrajeetPatil/broomExtra.svg?branch=master)](https://travis-ci.org/IndrajeetPatil/broomExtra)
[![Codecov test coverage](https://codecov.io/gh/IndrajeetPatil/broomExtra/branch/master/graph/badge.svg)](https://codecov.io/gh/IndrajeetPatil/broomExtra?branch=master)
[![Coverage Status](https://coveralls.io/repos/github/IndrajeetPatil/broomExtra/badge.svg?branch=master)](https://coveralls.io/github/IndrajeetPatil/broomExtra?branch=master)
[![Project Status: Active - The project has reached a stable, usable state and is being actively developed.](http://www.repostatus.org/badges/latest/active.svg)](http://www.repostatus.org/#active)
[![Last-changedate](https://img.shields.io/badge/last%20change-`r gsub('-', '--', Sys.Date())`-yellowgreen.svg)](https://github.com/IndrajeetPatil/broomExtra/commits/master)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-red.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![minimal R version](https://img.shields.io/badge/R%3E%3D-3.5.0-6666ff.svg)](https://cran.r-project.org/)
[![dependencies](https://tinyverse.netlify.com/badge/broomExtra)
<!-- badges: end -->

The goal of `broomExtra` is to provide helper functions that assist in data
analysis workflows involving packages `broom` and `broom.mixed`.

# Installation

To get the latest, stable `CRAN` release (`0.0.3`):

```{r installation1, eval = FALSE, warning = FALSE, messsage = FALSE}
utils::install.packages(pkgs = "broomExtra")
```

You can get the **development** version of the package from GitHub
(`0.0.3.9000`). To see what new changes (and bug fixes) have been made to the
package since the last release on `CRAN`, you can check the detailed log of
changes here: <https://indrajeetpatil.github.io/broomExtra/news/index.html> 

If you are in hurry and want to reduce the time of installation, prefer-

```{r installation2, eval = FALSE, warning = FALSE, messsage = FALSE}
# needed package to download from GitHub repo
utils::install.packages(pkgs = "remotes")
remotes::install_github(
  repo = "IndrajeetPatil/broomExtra", # package path on GitHub
  quick = TRUE # skips docs, demos, and vignettes
)
```

If time is not a constraint-
```{r installation3, eval = FALSE, warning = FALSE, messsage = FALSE}
remotes::install_github(
  repo = "IndrajeetPatil/broomExtra", # package path on GitHub
  dependencies = TRUE, # installs packages which broomExtra depends on
  upgrade_dependencies = TRUE # updates any out of date dependencies
)
```

```{r install, eval = FALSE}
remotes::install_github("IndrajeetPatil/broomExtra")
```

# generic functions

Currently, `S3` methods for mixed-effects model objects are included in the
`broom.mixed` package, while the rest of the object classes are included in the
`broom` package. This means that you constantly need to keep track of the class
of the object (e.g., "if it is `merMod` object, use
`broom.mixed::tidy()`/`broom.mixed::glance()`/`broom.mixed::augment()`, but if
it is `polr` object, use `broom::tidy()`/`broom::glance()`/`broom::augment()`").
Using generics from `broomExtra` means you no longer have to worry about this,
as calling `broomExtra::tidy()`/`broomExtra::glance()`/`broomExtra::augment()`
will search the appropriate method from these two packages and return the
results.

## tidy dataframe

Let's get a tidy tibble back containing results from various regression models.

```{r tidy}
set.seed(123)
library(lme4)
library(ordinal)

# mixed-effects models (`broom.mixed` will be used)
lmm.mod <- lmer(Reaction ~ Days + (Days | Subject), sleepstudy)
broomExtra::tidy(x = lmm.mod, effects = "fixed")

# linear model (`broom` will be used)
lm.mod <- lm(Reaction ~ Days, sleepstudy)
broomExtra::tidy(x = lm.mod, conf.int = TRUE)

# another example with `broom`
# cumulative Link Models
clm.mod <- clm(rating ~ temp * contact, data = wine)
broomExtra::tidy(
  x = clm.mod,
  exponentiate = TRUE,
  conf.int = TRUE,
  conf.type = "Wald"
)

# unsupported object (the function will return `NULL` in such cases)
x <- c(2, 2:4, 4, 4, 5, 5, 7, 7, 7)
y <- c(1:6, 5:4, 3:1)
appr <- stats::approx(x, y, xout = x)
broomExtra::tidy(appr)
```

## model summaries

Getting a `tibble` containing model summary and other performance measures.

```{r glance}
set.seed(123)
library(lme4)
library(ordinal)

# mixed-effects model
lmm.mod <- lmer(Reaction ~ Days + (Days | Subject), sleepstudy)
broomExtra::glance(lmm.mod)

# linear model
lm.mod <- lm(Reaction ~ Days, sleepstudy)
broomExtra::glance(lm.mod)

# another example with `broom`
# cumulative Link Models
clm.mod <- clm(rating ~ temp * contact, data = wine)
broomExtra::glance(clm.mod)

# in case no glance method is available (`NULL` will be returned)
broomExtra::glance(stats::anova(stats::lm(wt ~ am, mtcars)))
```

## augmented dataframe

Getting a `tibble` by augmenting data with information from an object.

```{r augment}
set.seed(123)
library(lme4)
library(ordinal)

# mixed-effects model
lmm.mod <- lmer(Reaction ~ Days + (Days | Subject), sleepstudy)
broomExtra::augment(lmm.mod)

# linear model
lm.mod <- lm(Reaction ~ Days, sleepstudy)
broomExtra::augment(lm.mod)

# another example with `broom`
# cumulative Link Models
clm.mod <- clm(rating ~ temp * contact, data = wine)
broomExtra::augment(x = clm.mod, newdata = wine, type.predict = "prob")

# in case no augment method is available (`NULL` will be returned)
broomExtra::augment(stats::anova(stats::lm(wt ~ am, mtcars)))
```

# `grouped_` variants of generics

`grouped` variants of the generic functions (`tidy`, `glance`, and `augment`)
make it easy to execute the same analysis for all combinations of grouping
variable(s) in a dataframe. Currently, these functions work only for methods
that depend on a `data` argument (e.g., `stats::lm`), but not for functions that
don't (e.g., `stats::prop.test()`).

## `grouped_tidy`

```{r grouped_tidy}
# to speed up computation, let's use only 50% of the data
set.seed(123)
library(lme4)
library(ggplot2)

# linear model (tidy analysis across grouping combinations)
broomExtra::grouped_tidy(
  data = dplyr::sample_frac(tbl = ggplot2::diamonds, size = 0.5),
  grouping.vars = c(cut, color),
  formula = price ~ carat - 1,
  ..f = stats::lm,
  na.action = na.omit,
  tidy.args = list(quick = TRUE)
)

# linear mixed effects model (tidy analysis across grouping combinations)
broomExtra::grouped_tidy(
  data = dplyr::sample_frac(tbl = ggplot2::diamonds, size = 0.5),
  grouping.vars = cut,
  ..f = lme4::lmer,
  formula = price ~ carat + (carat | color) - 1,
  control = lme4::lmerControl(optimizer = "bobyqa"),
  tidy.args = list(conf.int = TRUE, conf.level = 0.99)
)
```

## `grouped_glance`

```{r grouped_glance}
# to speed up computation, let's use only 50% of the data
set.seed(123)

# linear model (model summaries across grouping combinations)
broomExtra::grouped_glance(
  data = dplyr::sample_frac(tbl = ggplot2::diamonds, size = 0.5),
  grouping.vars = c(cut, color),
  formula = price ~ carat - 1,
  ..f = stats::lm,
  na.action = na.omit
)

# linear mixed effects model (model summaries across grouping combinations)
broomExtra::grouped_glance(
  data = dplyr::sample_frac(tbl = ggplot2::diamonds, size = 0.5),
  grouping.vars = cut,
  ..f = lme4::lmer,
  formula = price ~ carat + (carat | color) - 1,
  control = lme4::lmerControl(optimizer = "bobyqa")
)
```

## `grouped_augment`

```{r grouped_augment}
# to speed up computation, let's use only 50% of the data
set.seed(123)

# linear model
broomExtra::grouped_augment(
  data = ggplot2::diamonds,
  grouping.vars = c(cut, color),
  ..f = stats::lm,
  formula = price ~ carat - 1
)

# linear mixed-effects model
broomExtra::grouped_augment(
  data = dplyr::sample_frac(tbl = ggplot2::diamonds, size = 0.5),
  grouping.vars = cut,
  ..f = lme4::lmer,
  formula = price ~ carat + (carat | color) - 1,
  control = lme4::lmerControl(optimizer = "bobyqa")
)
```

# `boot_` variants of generics

`boot` variants of the generic functions (`tidy`, `glance`, and `augment`) make
it easy to create a tidy dataframe of estimates from each of the bootstrap
samples (created using `rsample::bootstraps`). Currently, these functions work
only for methods that depend on a `data` argument (e.g., `lme4::lmer`), but not
for functions that don't (e.g., `stats::chisq.test()`).

## `boot_tidy`

Let's see an example with linear mixed-effects regression.

```{r boot_tidy}
# setup
set.seed(123)
library(lme4)
library(ggplot2)
library(broomExtra)

# dataframe with estimates from each of the 25 bootstrap sample
(df_boot <- broomExtra::boot_tidy(
  data = sleepstudy,
  times = 100,
  ..f = lme4::lmer,
  formula = Reaction ~ Days + (Days | Subject),
  control = lme4::lmerControl(
    check.conv.grad = .makeCC("ignore", tol = 2e-3, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore", tol = 1e-4),
    check.conv.hess = .makeCC(action = "ignore", tol = 1e-6)
  ),
  tidy.args = list(effects = "fixed")
))

# plotting estimates from each bootstrapped sample
dplyr::filter(df_boot, term != "(Intercept)") %>%
  tibble::rowid_to_column(.data = .) %>%
  ggplot(data = ., aes(rowid, estimate)) +
  geom_point(size = 3, alpha = 0.5, color = "red") + geom_line() +
  ggstatsplot::theme_ggstatsplot() +
  labs(
    title = "regression estimates from bootstrap samples",
    x = "bootstrap sample",
    y = "regression estimate"
  )
```

## `boot_glance`

A similar function can also be used to extract model summaries from bootstrapped
samples.

```{r boot_glance}
# setup
set.seed(123)
library(ggplot2)

# dataframe with model summaries from each of the 500 bootstrap samples
(df_glance <-
  broomExtra::boot_glance(
    data = mtcars,
    times = 500,
    ..f = stats::lm,
    formula = mpg ~ wt,
    na.action = na.omit
  )
)

# plotting log-likelihood for the model for each of the samples
tibble::rowid_to_column(.data = df_glance) %>%
  ggplot(data = ., aes(rowid, logLik)) +
  geom_point(size = 3, alpha = 0.5, color = "darkgreen") + geom_line() +
  ggstatsplot::theme_ggstatsplot() +
  labs(
    title = "log-likelihood of the model from bootstrap samples",
    x = "bootstrap sample",
    y = "log-likelihood"
  )
```

## `boot_augment`

```{r boot_augment}
# setup
set.seed(123)
library(ggplot2)

# dataframe with augmented data from each of the 100 bootstrap samples
(df_augment <-
  broomExtra::boot_augment(
    data = mtcars,
    times = 500,
    ..f = stats::lm,
    formula = mpg ~ wt,
    na.action = na.omit,
    augment.args = list(se_fit = TRUE)
  )
)

# plotting those estimates
dplyr::group_by(.data = df_augment, id) %>%
  dplyr::summarise(.data = ., mean.resid = mean(.resid)) %>%
  dplyr::ungroup(x = .) %>% 
  tibble::rowid_to_column(.data = .) %>% # creating a plot
  ggplot(data = ., aes(rowid, mean.resid)) +
  geom_point(size = 3, alpha = 0.5, color = "blue") + 
  geom_line(color = "black") +
  geom_hline(aes(yintercept = 0),
             color = "red",
             size = 1,
             linetype = "dashed") +
  ggstatsplot::theme_ggstatsplot() +
  labs(
    title = "mean difference between fitted and observed values from bootstrap samples",
    x = "bootstrap sample",
    y = "residual score"
  )
```

# Code coverage

As the code stands right now, here is the code coverage for all primary
functions involved:
<https://codecov.io/gh/IndrajeetPatil/broomExtra/tree/master/R>

# Contributing

I'm happy to receive bug reports, suggestions, questions, and (most of all)
contributions to fix problems and add features. I personally prefer using the
`GitHub` issues system over trying to reach out to me in other ways (personal
e-mail, Twitter, etc.). Pull requests for contributions are encouraged.

Please note that this project is released with a 
[Contributor Code of Conduct](https://github.com/IndrajeetPatil/broomExtra/blob/master/CODE_OF_CONDUCT.md). By participating in this project
you agree to abide by its terms.
